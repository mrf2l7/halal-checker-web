<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Halal Stock Checker (SEC)</title>
    <style>
      body{font-family:system-ui,Segoe UI,Tahoma,Arial,sans-serif;max-width:900px;margin:40px auto;padding:16px}
      .row{display:flex;gap:8px;margin:12px 0}
      input{flex:1;padding:10px 12px;border:1px solid #ddd;border-radius:10px;text-transform:uppercase}
      button{padding:10px 16px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
      .card{border:1px solid #eee;border-radius:12px;padding:16px;margin-top:12px}
      .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px}
      .tile{border:1px solid #f1f1f1;border-radius:10px;padding:12px}
      .k{opacity:.7;font-size:12px}
      .v{font-size:20px;font-weight:700}
      .badge{padding:6px 10px;border-radius:16px;font-weight:700}
      .ok{background:#e6f7e9;color:#167c2b}
      .bad{background:#fde8e8;color:#b00020}
      .warn{background:#fff8e1;color:#a67c00}
      .neutral{background:#e9f2ff;color:#0a53a3}
      .muted{opacity:.65;font-size:12px;margin-top:10px}
      .err{color:#b00020;margin-top:8px}
      .source{font-size:12px;opacity:.7;margin-inline-start:8px}
      .row-top{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
      .hint{opacity:.75;margin:0 0 8px 0}
      .note{font-size:12px;opacity:.75}
    </style>
  </head>
  <body>
    <h1>Halal Stock Checker (SEC)</h1>
    <p class="hint">المصدر أولاً SEC (Submissions + XBRL CompanyFacts) عبر بروكسيك على Vercel. وإذا نقصت بيانات الربع نستخدم FMP كبديل واضح.</p>

    <div class="row">
      <input id="ticker" placeholder="AAPL, TSLA, MSFT ..." />
      <button id="btn">فحص</button>
    </div>

    <div id="error" class="err"></div>
    <div id="out"></div>

    <script>
      /* ===== إعدادات ===== */
      const PROXY = "https://sec-proxy.vercel.app/api/sec-proxy"; // بروكسيك السابق
      const FMP_KEY = "demo"; // ← استبدلها بمفتاحك من FMP بعد التسجيل

      const LIMITS = { MAX_DTA: 0.30, MAX_CTA: 0.30, MAX_IMPURE: 0.05 };
      const BANNED = [
        "alcohol","brewery","wine","spirits","gambling","casino","lottery",
        "pork","swine","pig","tobacco","cannabis","adult","porn",
        "bank","banking","mortgage","insurance","reinsurance","weapons","firearms","defense"
      ];

      const pct = x => (typeof x === "number" ? (x*100).toFixed(2) + "%" : "-");
      const sleep = ms => new Promise(r=>setTimeout(r,ms));

      /* ===== مساعدات جلب من SEC عبر البروكسي ===== */
      async function fetchSEC(url, type="json", retries=4){
        let lastErr;
        for(let i=0;i<retries;i++){
          try{
            await sleep(250 + i*600);
            const r = await fetch(PROXY + "?u=" + encodeURIComponent(url), {cache:"no-store"});
            if(!r.ok) throw new Error("SEC HTTP "+r.status);
            return (type==="text") ? await r.text() : await r.json();
          }catch(e){ lastErr = e; }
        }
        throw lastErr || new Error("SEC fetch failed");
      }

      function pad10(cik){ let s=String(Math.trunc(Number(cik)||0)); while(s.length<10) s="0"+s; return s; }
      function safeDiv(a,b){ return (isFinite(a)&&isFinite(b)&&b!==0)?(a/b):0; }
      function firstNZ(arr){ for(const x of arr){ if(isFinite(x)&&x>0) return x; } return 0; }
      function sum(arr){ return arr.reduce((s,x)=>s+(isFinite(x)?x:0),0); }
      function sumPos(arr){ return arr.reduce((s,x)=>s+(isFinite(x)&&x>0?x:0),0); }

      // نختار "آخر ربع" 10-Q إن وجد، وإلا أحدث قيمة أيًا كان النموذج
      function pickLatestQuarter(gaapNode){
        if(!gaapNode || !gaapNode.units) return null;
        const usd = gaapNode.units.USD || gaapNode.units.usd;
        if(!usd) return null;

        // نفصل 10-Q عن غيره
        const q = usd.filter(e => (e.form||"").toUpperCase()==="10-Q");
        const any = usd.slice();

        const sortByEndDesc = (a,b)=> new Date(b.end||0) - new Date(a.end||0);

        let candidate = null;
        if(q.length){
          candidate = q.sort(sortByEndDesc)[0];
        } else if(any.length){
          candidate = any.sort(sortByEndDesc)[0];
        }
        if(candidate && isFinite(Number(candidate.val))){
          return { val:Number(candidate.val), form:candidate.form||"", end:candidate.end||"" };
        }
        return null;
      }

      function pickFromGaap(F, keys){
        for (const k of keys) {
          const p = pickLatestQuarter(F[k]);
          if(p) return p;
        }
        return null;
      }

      async function mapTickerToCik(ticker){
        try{
          const txt = await fetchSEC("https://www.sec.gov/include/ticker.txt","text");
          const hit = txt.split(/\r?\n/).find(line => {
            const p=line.trim().split(/[|\s]+/);
            return p[0] && p[0].toUpperCase()===ticker.toUpperCase();
          });
          if(hit){
            const parts = hit.trim().split(/[|\s]+/);
            const cikStr = parts[1].replace(/^0+/,"");
            return Number(cikStr);
          }
        }catch(_){}
        try{
          const j1 = await fetchSEC("https://www.sec.gov/files/company_tickers.json");
          const a1 = Array.isArray(j1)?j1:Object.values(j1||{});
          const h1 = a1.find(o => (o.ticker||"").toUpperCase()===ticker.toUpperCase());
          if(h1) return Number(h1.cik_str || h1.cik);
        }catch(_){}
        const j2 = await fetchSEC("https://www.sec.gov/files/company_tickers_exchange.json");
        const a2 = Array.isArray(j2)?j2:Object.values(j2||{});
        const h2 = a2.find(o => (o.ticker||"").toUpperCase()===ticker.toUpperCase());
        if(h2) return Number(h2.cik_str || h2.cik);
        throw new Error("Ticker not found via SEC maps");
      }

      /* ===== FMP (فصل ربعي) كبديل عند نقص SEC ===== */
      async function fetchFromFMPQuarter(ticker){
        const base = "https://financialmodelingprep.com/api/v3";
        const qs = `?period=quarter&limit=1&apikey=${encodeURIComponent(FMP_KEY)}`;

        const [bsRes, isRes] = await Promise.all([
          fetch(`${base}/balance-sheet-statement/${encodeURIComponent(ticker)}${qs}`),
          fetch(`${base}/income-statement/${encodeURIComponent(ticker)}${qs}`)
        ]);
        if(!bsRes.ok || !isRes.ok) throw new Error("FMP HTTP error");

        const bsArr = await bsRes.json();
        const isArr = await isRes.json();
        const bs = Array.isArray(bsArr) && bsArr[0] ? bsArr[0] : {};
        const is_ = Array.isArray(isArr) && isArr[0] ? isArr[0] : {};

        const getNum = v => { const n=Number(v); return isFinite(n)?n:null; };

        const assets = getNum(bs.totalAssets) ?? getNum(bs.totalAssetsUSD) ?? 0;
        const debt   = (getNum(bs.totalDebt) ?? ((getNum(bs.shortTermDebt)||0)+(getNum(bs.longTermDebt)||0)) ) || 0;
        const cash   = getNum(bs.cashAndShortTermInvestments) ?? ((getNum(bs.cashAndCashEquivalents)||0)+(getNum(bs.shortTermInvestments)||0)) || 0;
        const revenue= getNum(is_.revenue) ?? getNum(is_.totalRevenue) ?? 0;
        // نعدّ الإيراد غير المباح كفوائد مكتسبة إن وجدت
        const interestIncome = Math.max(
          0,
          getNum(is_.interestIncome) ?? getNum(is_.interestIncomeNet) ?? getNum(is_.investmentIncome) ?? 0
        );

        return {
          assets, debt, cash, revenue, interestIncome,
          form: "FMP-Q", end: is_.date || bs.date || ""
        };
      }

      /* ===== العرض ===== */
      function render(t, cik, data, source, reportMeta){
        const out = document.getElementById("out");
        const badClass =
          data.status==="Halal" ? "ok" :
          data.status==="Haram" ? "bad" :
          data.status==="Needs Purification" ? "warn" :
          "neutral"; // Mubah

        const rep = reportMeta ? `${reportMeta.form || ""} — ${reportMeta.end || ""}` : "";
        const noteLine = data.note ? data.note
          : (data.status==="Mubah" ? "لا توجد بيانات ربعيّة كافية (IPO/اندماج). الأصل الإباحة حتى ظهور أول 10-Q."
             : "");

        out.innerHTML = `
          <div class="card">
            <div class="row-top">
              <div>
                <div style="font-size:18px;font-weight:600">${t} — CIK ${String(cik).padStart(10,"0")}
                  <span class="source">Source: ${source}</span>
                </div>
                <div class="note">${rep}</div>
              </div>
              <span class="badge ${badClass}">${data.status}</span>
            </div>

            <div class="grid">
              <div class="tile"><div class="k">Impure Revenue</div><div class="v">${pct(data.irr)}</div></div>
              <div class="tile"><div class="k">Cash / Assets</div><div class="v">${pct(data.cta)}</div></div>
              <div class="tile"><div class="k">Debt / Assets</div><div class="v">${pct(data.dta)}</div></div>
            </div>

            <div class="muted">${noteLine}</div>
            <div class="muted">المعايير (ربعي): الدين ≤ 30%، النقدية ≤ 30%، الإيراد غير المباح ≤ 5%.</div>
          </div>`;
      }

      function decideStatus(dta, cta, irr){
        const debtOk = isFinite(dta) && dta <= LIMITS.MAX_DTA;
        const cashOk = isFinite(cta) && cta <= LIMITS.MAX_CTA;

        if(!debtOk || !cashOk){
          const reasons=[];
          if(!debtOk) reasons.push(`Debt/Assets > ${(LIMITS.MAX_DTA*100).toFixed(0)}%`);
          if(!cashOk) reasons.push(`Cash/Assets > ${(LIMITS.MAX_CTA*100).toFixed(0)}%`);
          if(irr > LIMITS.MAX_IMPURE) reasons.push(`Impure Rev ${(irr*100).toFixed(2)}% > ${(LIMITS.MAX_IMPURE*100).toFixed(0)}%`);
          return { status:"Haram", note: reasons.join(" | ") };
        }
        if(irr===0) return { status:"Halal", note:"" };
        if(irr>0 && irr<=LIMITS.MAX_IMPURE) return { status:"Needs Purification", note:`Purification = ${(irr*100).toFixed(2)}% of gains.` };
        return { status:"Haram", note:`Impure revenue ${(irr*100).toFixed(2)}% > ${(LIMITS.MAX_IMPURE*100).toFixed(0)}%.` };
      }

      /* ===== الحدث الرئيسي ===== */
      document.getElementById("btn").onclick = async () => {
        const t = document.getElementById("ticker").value.trim().toUpperCase();
        const out = document.getElementById("out");
        const err = document.getElementById("error");
        err.textContent = ""; out.innerHTML = "";
        if(!t){ err.textContent = "اكتب رمز السهم أولاً"; return; }

        try{
          let source = "SEC";
          const cik = await mapTickerToCik(t);

          // فحص النشاط
          const submissions = await fetchSEC(`https://data.sec.gov/submissions/CIK${pad10(cik)}.json`);
          const sicDesc = (submissions.sicDescription || "").toLowerCase();
          const banned = BANNED.find(k => sicDesc.includes(k));
          if (banned){
            render(t, cik, {dta:null, cta:null, irr:null, status:"Haram",
              note:`Excluded by SIC: ${submissions.sic} ${submissions.sicDescription||""}`},
              source, {form:"SIC", end:""});
            return;
          }

          // CompanyFacts (نحاول ربعي 10-Q)
          let assets=null, debt=null, cash=null, revenue=null, interestIncome=0;
          let form="", end="";

          try{
            const facts = await fetchSEC(`https://data.sec.gov/api/xbrl/companyfacts/CIK${pad10(cik)}.json`);
            const F = (facts.facts && facts.facts["us-gaap"]) ? facts.facts["us-gaap"] : {};

            const pAssets  = pickFromGaap(F,["Assets"]);
            const pDebt    = pickFromGaap(F,["Debt","InterestBearingLiabilities","Liabilities"]);
            const pCashA   = pickFromGaap(F,["CashAndCashEquivalentsAtCarryingValue"]);
            const pSTI     = pickFromGaap(F,["ShortTermInvestments"]);
            const pRevenue = pickFromGaap(F,["Revenues","SalesRevenueNet","RevenueFromContractWithCustomerExcludingAssessedTax"]);
            const pIntInc1 = pickFromGaap(F,["InterestIncome"]);
            const pIntInc2 = pickFromGaap(F,["InterestAndDividendIncomeOperating"]);
            const pIntInc3 = pickFromGaap(F,["InterestAndDividendIncome"]);
            const pIntInc4 = pickFromGaap(F,["InterestIncomeNonoperating"]);
            const pIntInc5 = pickFromGaap(F,["InvestmentIncomeInterest"]);

            // نأخذ آخر ربع (لو نفس الربع لعدة عناصر نستخدم الأحدث)
            const allMeta = [pAssets,pDebt,pCashA,pSTI,pRevenue].filter(Boolean).sort((a,b)=>new Date(b.end||0)-new Date(a.end||0));
            if(allMeta[0]){ form = allMeta[0].form || ""; end = allMeta[0].end || ""; }

            assets  = pAssets?.val ?? null;
            debt    = pDebt?.val ?? null;
            cash    = (pCashA?.val||0) + (pSTI?.val||0);
            revenue = pRevenue?.val ?? null;
            interestIncome = sumPos([
              pIntInc1?.val||0, pIntInc2?.val||0, pIntInc3?.val||0, pIntInc4?.val||0, pIntInc5?.val||0
            ]);
          }catch(_){}

          // إذا ما لقينا بيانات ربعية كافية → جرّب FMP ربعي
          if(!(assets>0 && revenue>0)){
            const f = await fetchFromFMPQuarter(t);
            assets = assets || f.assets;
            debt = (debt ?? 0) || f.debt;
            cash = (cash ?? 0) || f.cash;
            revenue = revenue || f.revenue;
            interestIncome = interestIncome || f.interestIncome || 0;
            form = f.form; end = f.end;
            source = "FMP (quarter)";
          }

          // إذا لا SEC ولا FMP جابوا بيانات ربعيّة → مباح (غير مؤكد)
          if(!(assets>0 && revenue>0)){
            render(t, cik, {dta:null, cta:null, irr:null, status:"Mubah", note:"No recent quarterly data (IPO/merger)."}, source, {form, end});
            return;
          }

          const dta = safeDiv(debt||0, assets||1);
          const cta = safeDiv(cash||0, assets||1);
          const irr = Math.min(1, safeDiv(interestIncome||0, revenue||1));

          const decision = decideStatus(dta, cta, irr);
          render(t, cik, {dta,cta,irr,status:decision.status,note:decision.note}, source, {form, end});
        }catch(e){
          document.getElementById("error").textContent = "Error: " + (e.message || e);
        }
      };
    </script>
  </body>
</html>
