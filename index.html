<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Halal Stock Checker (SEC)</title>
    <style>
      body{font-family:system-ui,Segoe UI,Tahoma,Arial,sans-serif;max-width:860px;margin:40px auto;padding:16px}
      .row{display:flex;gap:8px;margin:12px 0}
      input{flex:1;padding:10px 12px;border:1px solid #ddd;border-radius:10px;text-transform:uppercase}
      button{padding:10px 16px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
      .card{border:1px solid #eee;border-radius:12px;padding:16px;margin-top:12px}
      .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px}
      .tile{border:1px solid #f1f1f1;border-radius:10px;padding:12px}
      .k{opacity:.7;font-size:12px}
      .v{font-size:20px;font-weight:700}
      .badge{padding:6px 10px;border-radius:16px;font-weight:700}
      .ok{background:#e6f7e9;color:#167c2b}
      .bad{background:#fde8e8;color:#b00020}
      .warn{background:#fff8e1;color:#a67c00}
      .muted{opacity:.65;font-size:12px;margin-top:10px}
      .err{color:#b00020;margin-top:8px}
    </style>
  </head>
  <body>
    <h1>Halal Stock Checker (SEC)</h1>
    <p class="muted">المصدر: ملفات SEC الرسمية (Submissions + XBRL CompanyFacts) عبر بروكسيك على Vercel.</p>

    <div class="row">
      <input id="ticker" placeholder="AAPL, TSLA, MSFT ..." />
      <button id="btn">فحص</button>
    </div>

    <div id="error" class="err"></div>
    <div id="out"></div>

    <script>
      // غيّر هذا لو دومين البروكسي عندك مختلف
      const PROXY = "https://sec-proxy.vercel.app/api/sec-proxy";

      const LIMITS = { MAX_DTA: 0.30, MAX_CTA: 0.30, MAX_IMPURE: 0.05 };
      const BANNED = [
        "alcohol","brewery","wine","spirits","gambling","casino","lottery",
        "pork","swine","pig","tobacco","cannabis","adult","porn",
        "bank","banking","mortgage","insurance","reinsurance","weapons","firearms","defense"
      ];

      const pct = x => (typeof x === "number" ? (x*100).toFixed(2) + "%" : "-");
      const sleep = ms => new Promise(r=>setTimeout(r,ms));

      async function fetchSEC(url, type="json", retries=4){
        let lastErr;
        for(let i=0;i<retries;i++){
          try{
            await sleep(250 + i*600); // pacing + backoff
            const r = await fetch(PROXY + "?u=" + encodeURIComponent(url), {cache:"no-store"});
            if(!r.ok) throw new Error("HTTP "+r.status+" from SEC");
            return (type==="text") ? await r.text() : await r.json();
          }catch(e){ lastErr = e; }
        }
        throw lastErr || new Error("Fetch failed");
      }

      function pad10(cik){ let s=String(Math.trunc(Number(cik)||0)); while(s.length<10) s="0"+s; return s; }
      function safeDiv(a,b){ return (isFinite(a)&&isFinite(b)&&b!==0)?(a/b):0; }
      function firstNZ(arr){ for(const x of arr){ if(isFinite(x)&&x>0) return x; } return 0; }
      function sum(arr){ return arr.reduce((s,x)=>s+(isFinite(x)?x:0),0); }
      function sumPos(arr){ return arr.reduce((s,x)=>s+(isFinite(x)&&x>0?x:0),0); }

      function pick(gaap, keys){
        for (const k of keys) {
          const node = gaap[k]; if(!node||!node.units) continue;
          const usd = node.units.USD || node.units.usd; if(!usd) continue;
          const tenK = usd.filter(e=>(e.form||"").toUpperCase()==="10-K");
          const tenQ = usd.filter(e=>(e.form||"").toUpperCase()==="10-Q");
          const pool = (tenK.length?tenK:tenQ).slice().sort((a,b)=>new Date(b.end||0)-new Date(a.end||0));
          const p = pool[0];
          if(p && isFinite(Number(p.val))) return Number(p.val);
        }
        return 0;
      }

      async function mapTickerToCik(ticker){
        // 1) include/ticker.txt
        try{
          const txt = await fetchSEC("https://www.sec.gov/include/ticker.txt","text");
          const hit = txt.split(/\r?\n/).find(line => {
            const p=line.trim().split(/[|\s]+/);
            return p[0] && p[0].toUpperCase()===ticker.toUpperCase();
          });
          if(hit){
            const parts = hit.trim().split(/[|\s]+/);
            const cikStr = parts[1].replace(/^0+/,"");
            return Number(cikStr);
          }
        }catch(_){}
        // 2) files/company_tickers.json
        try{
          const j1 = await fetchSEC("https://www.sec.gov/files/company_tickers.json");
          const a1 = Array.isArray(j1)?j1:Object.values(j1||{});
          const h1 = a1.find(o => (o.ticker||"").toUpperCase()===ticker.toUpperCase());
          if(h1) return Number(h1.cik_str || h1.cik);
        }catch(_){}
        // 3) files/company_tickers_exchange.json
        const j2 = await fetchSEC("https://www.sec.gov/files/company_tickers_exchange.json");
        const a2 = Array.isArray(j2)?j2:Object.values(j2||{});
        const h2 = a2.find(o => (o.ticker||"").toUpperCase()===ticker.toUpperCase());
        if(h2) return Number(h2.cik_str || h2.cik);
        throw new Error("Ticker not found via SEC maps");
      }

      document.getElementById("btn").onclick = async () => {
        const t = document.getElementById("ticker").value.trim().toUpperCase();
        const out = document.getElementById("out");
        const err = document.getElementById("error");
        err.textContent = ""; out.innerHTML = "";
        if(!t){ err.textContent = "اكتب رمز السهم أولاً"; return; }

        try{
          // 1) Ticker → CIK
          const cik = await mapTickerToCik(t);

          // 2) فحص النشاط (SIC)
          const submissions = await fetchSEC(`https://data.sec.gov/submissions/CIK${pad10(cik)}.json`);
          const sicDesc = (submissions.sicDescription || "").toLowerCase();
          const banned = BANNED.find(k => sicDesc.includes(k));
          if (banned){
            out.innerHTML = `
              <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div><div style="font-size:18px;font-weight:600">${t} — CIK ${String(cik).padStart(10,"0")}</div>
                  <div class="muted" style="margin-top:4px">Excluded by SIC: ${submissions.sic} ${submissions.sicDescription||""}</div></div>
                  <span class="badge bad">Haram</span>
                </div>
              </div>`;
            return;
          }

          // 3) CompanyFacts
          const facts = await fetchSEC(`https://data.sec.gov/api/xbrl/companyfacts/CIK${pad10(cik)}.json`);
          const F = (facts.facts && facts.facts["us-gaap"]) ? facts.facts["us-gaap"] : {};

          const assets  = pick(F,["Assets"]);
          const debt    = firstNZ([ pick(F,["Debt"]), pick(F,["InterestBearingLiabilities"]), pick(F,["Liabilities"]) ]);
          const cash    = sum([ pick(F,["CashAndCashEquivalentsAtCarryingValue"]), pick(F,["ShortTermInvestments"]) ]);
          const revenue = firstNZ([ pick(F,["Revenues"]), pick(F,["SalesRevenueNet"]), pick(F,["RevenueFromContractWithCustomerExcludingAssessedTax"]) ]);
          const interestIncome = sumPos([
            pick(F,["InterestIncome"]),
            pick(F,["InterestAndDividendIncomeOperating"]),
            pick(F,["InterestAndDividendIncome"]),
            pick(F,["InterestIncomeNonoperating"]),
            pick(F,["InvestmentIncomeInterest"])
          ]);

          if(!assets || !revenue) throw new Error("Insufficient SEC data (Assets or Revenue).");

          const dta = debt ? (debt/assets) : 0;
          const cta = cash ? (cash/assets) : 0;
          const irr = Math.min(1, revenue ? (interestIncome / revenue) : 0);

          const debtOk = isFinite(dta) && dta <= LIMITS.MAX_DTA;
          const cashOk = isFinite(cta) && cta <= LIMITS.MAX_CTA;

          let status="Halal", note="";
          if(!debtOk || !cashOk){
            status="Haram";
            const reasons=[];
            if(!debtOk) reasons.push(`Debt/Assets > ${(LIMITS.MAX_DTA*100).toFixed(0)}%`);
            if(!cashOk) reasons.push(`Cash/Assets > ${(LIMITS.MAX_CTA*100).toFixed(0)}%`);
            if(irr > LIMITS.MAX_IMPURE) reasons.push(`Impure Rev ${(irr*100).toFixed(2)}% > ${(LIMITS.MAX_IMPURE*100).toFixed(0)}%`);
            note = reasons.join(" | ");
          }else{
            if(irr===0) status="Halal";
            else if(irr>0 && irr<=LIMITS.MAX_IMPURE){
              status="Needs Purification";
              note = `Purification = ${(irr*100).toFixed(2)}% of gains.`;
            }else{
              status="Haram";
              note = `Impure revenue ${(irr*100).toFixed(2)}% > ${(LIMITS.MAX_IMPURE*100).toFixed(0)}%.`;
            }
          }

          const badgeClass = status==="Halal" ? "ok" : (status==="Haram" ? "bad" : "warn");
          out.innerHTML = `
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div style="font-size:18px;font-weight:600">${t} — CIK ${String(cik).padStart(10,"0")}</div>
                  <div class="muted" style="margin-top:4px">${note || "&nbsp;"}</div>
                </div>
                <span class="badge ${badgeClass}">${status}</span>
              </div>
              <div class="grid">
                <div class="tile"><div class="k">Debt / Assets</div><div class="v">${pct(dta)}</div></div>
                <div class="tile"><div class="k">Cash / Assets</div><div class="v">${pct(cta)}</div></div>
                <div class="tile"><div class="k">Impure Revenue</div><div class="v">${pct(irr)}</div></div>
              </div>
              <div class="muted">المعايير: الدين ≤ 30%، النقدية ≤ 30%، الإيراد غير المباح ≤ 5%.</div>
            </div>`;
        }catch(e){
          document.getElementById("error").textContent = "Error: " + (e.message || e);
        }
      };
    </script>
  </body>
</html>
