<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>فحص شرعي (ربع سنوي) — للمضارب</title>
    <style>
      :root{color-scheme:light dark}
      body{font-family:system-ui,Segoe UI,Tahoma,Arial,sans-serif;max-width:900px;margin:40px auto;padding:16px}
      h1{font-size:28px;margin:0 0 8px}
      .row{display:flex;gap:8px;margin:12px 0}
      input{flex:1;padding:12px;border:1px solid #ddd;border-radius:12px;text-transform:uppercase}
      button{padding:12px 16px;border-radius:12px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
      .card{border:1px solid #eee;border-radius:14px;padding:16px;margin-top:12px}
      .row-top{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
      .source{font-size:12px;opacity:.75;margin-inline-start:8px}
      .badge{padding:6px 10px;border-radius:16px;font-weight:700}
      .ok{background:#e6f7e9;color:#167c2b}
      .bad{background:#fde8e8;color:#b00020}
      .warn{background:#fff8e1;color:#a67c00}
      .neutral{background:#e9f2ff;color:#0a53a3}
      .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
      .tile{border:1px solid #f1f1f1;border-radius:12px;padding:12px}
      .k{opacity:.7;font-size:12px}
      .v{font-size:20px;font-weight:800}
      .muted{opacity:.65;font-size:12px;margin-top:10px}
      .err{color:#b00020;margin-top:8px}
    </style>
  </head>
  <body>
    <h1>فحص شرعي (ربع سنوي)</h1>

    <div class="row">
      <input id="ticker" placeholder="AAPL, TSLA, MSFT ..." />
      <button id="btn">فحص</button>
    </div>

    <div id="error" class="err"></div>
    <div id="out"></div>

    <script>
      /* إعدادات */
      const PROXY   = "https://sec-proxy.vercel.app/api/sec-proxy";   // بروكسي SEC
      const FMP_KEY = "pIugzfG67qw0hwcFvzzSzF2Zax1eZXt6";             // مفتاح FMP

      // حدود المضارب: آخر ربع فقط — الدين ≤30%، النقدية ≤30%، الدخل غير المباح ≤5%
      const LIMITS = { MAX_DTA: 0.30, MAX_CTA: 0.30, MAX_IMPURE: 0.05 };

      // أنشطة ممنوعة فوراً (سريعة لمضارب)
      const BANNED = [
        "alcohol","brewery","wine","spirits","gambling","casino","lottery",
        "pork","swine","pig","tobacco","cannabis","adult","porn",
        "bank","banking","mortgage","insurance","reinsurance","weapons","firearms","defense"
      ];

      const pct = x => (typeof x === "number" ? (x*100).toFixed(2) + "%" : "-");
      const sleep = ms => new Promise(r=>setTimeout(r,ms));
      const safeDiv = (a,b)=> (isFinite(a)&&isFinite(b)&&b!==0)?(a/b):0;
      const sumPos  = arr => arr.reduce((s,x)=>s+(isFinite(x)&&x>0?x:0),0);

      async function fetchSEC(url, type="json", retries=4){
        let lastErr;
        for(let i=0;i<retries;i++){
          try{
            await sleep(200 + i*400);
            const r = await fetch(PROXY + "?u=" + encodeURIComponent(url), {cache:"no-store"});
            if(!r.ok) throw new Error("SEC HTTP "+r.status);
            return (type==="text") ? await r.text() : await r.json();
          }catch(e){ lastErr = e; }
        }
        throw lastErr || new Error("SEC fetch failed");
      }

      function pad10(cik){ let s=String(Math.trunc(Number(cik)||0)); while(s.length<10) s="0"+s; return s; }

      async function mapTickerToCik(ticker){
        try{
          const txt = await fetchSEC("https://www.sec.gov/include/ticker.txt","text");
          const hit = txt.split(/\r?\n/).find(line => {
            const p=line.trim().split(/[|\s]+/);
            return p[0] && p[0].toUpperCase()===ticker.toUpperCase();
          });
          if(hit){
            const parts = hit.trim().split(/[|\s]+/);
            const cikStr = parts[1].replace(/^0+/,"");
            return Number(cikStr);
          }
        }catch(_){}
        try{
          const j1 = await fetchSEC("https://www.sec.gov/files/company_tickers.json");
          const a1 = Array.isArray(j1)?j1:Object.values(j1||{});
          const h1 = a1.find(o => (o.ticker||"").toUpperCase()===ticker.toUpperCase());
          if(h1) return Number(h1.cik_str || h1.cik);
        }catch(_){}
        const j2 = await fetchSEC("https://www.sec.gov/files/company_tickers_exchange.json");
        const a2 = Array.isArray(j2)?j2:Object.values(j2||{});
        const h2 = a2.find(o => (o.ticker||"").toUpperCase()===ticker.toUpperCase());
        if(h2) return Number(h2.cik_str || h2.cik);
        throw new Error("تعذّر إيجاد CIK لهذا الرمز.");
      }

      function lastTwoQuarterEnds(F){
        const ends = new Set();
        Object.values(F||{}).forEach(node=>{
          const usd = node?.units?.USD || node?.units?.usd;
          if(!usd) return;
          usd.forEach(e=>{
            if((e.form||"").toUpperCase()==="10-Q" && e.end) ends.add(e.end);
          });
        });
        const sorted = Array.from(ends).sort((a,b)=>new Date(b)-new Date(a));
        return sorted.slice(0,2);
      }

      function pickForEnd(F, keys, end){
        for(const k of keys){
          const node = F[k]; if(!node||!node.units) continue;
          const usd = node.units.USD || node.units.usd; if(!usd) continue;
          const exactQ = usd.find(e => (e.form||"").toUpperCase()==="10-Q" && e.end===end);
          if(exactQ && isFinite(Number(exactQ.val))) return Number(exactQ.val);
          const exactAny = usd.find(e => e.end===end);
          if(exactAny && isFinite(Number(exactAny.val))) return Number(exactAny.val);
        }
        return null;
      }

      // مفاتيح الدين الربوي فقط — لا نستخدم Liabilities
      const DEBT_KEYS_SEC = [
        "Debt",
        "LongTermDebt",
        "LongTermDebtNoncurrent",
        "DebtCurrent",
        "ShortTermBorrowings",
        "CommercialPaper",
        "LongTermDebtAndCapitalLeaseObligations",
        "LongTermBorrowings",
        "NotesPayable",
        "Borrowings"
      ];

      function tryPickQuarterSEC(F, ends){
        for(const end of ends){
          const assets  = pickForEnd(F,["Assets"], end);
          const debt    = sumPos(DEBT_KEYS_SEC.map(k=>pickForEnd(F,[k], end) || 0));
          const cash    = (pickForEnd(F,["CashAndCashEquivalentsAtCarryingValue"], end) || 0)
                        + (pickForEnd(F,["ShortTermInvestments"], end) || 0);
          const revenue = pickForEnd(F,[
            "Revenues","SalesRevenueNet",
            "RevenueFromContractWithCustomerExcludingAssessedTax",
            "SalesRevenueGoodsNet","SalesRevenueServicesNet"
          ], end);
          const interestIncome = sumPos([
            pickForEnd(F,["InterestIncome"], end) || 0,
            pickForEnd(F,["InterestAndDividendIncomeOperating"], end) || 0,
            pickForEnd(F,["InterestAndDividendIncome"], end) || 0,
            pickForEnd(F,["InterestIncomeNonoperating"], end) || 0,
            pickForEnd(F,["InvestmentIncomeInterest"], end) || 0
          ]);

          if(assets>0 && revenue>0){
            return { assets, debt, cash, revenue, interestIncome, form:"10-Q", end };
          }
        }
        return null;
      }

      async function fetchFromFMP_Q_LastTwo(ticker){
        const base = "https://financialmodelingprep.com/api/v3";
        const qs   = `?period=quarter&limit=2&datatype=json&apikey=${encodeURIComponent(FMP_KEY)}`;

        let bs = [], is_ = [];
        try{
          const [a,b] = await Promise.allSettled([
            fetch(`${base}/balance-sheet-statement/${encodeURIComponent(ticker)}${qs}`),
            fetch(`${base}/income-statement/${encodeURIComponent(ticker)}${qs}`)
          ]);
          if(a.status==="fulfilled" && a.value.ok) bs = await a.value.json();
          if(b.status==="fulfilled" && b.value.ok) is_ = await b.value.json();
        }catch(_){}

        for(let i=0;i<2;i++){
          const B = bs[i]||{}, I = is_[i]||{};
          const num = v=>{const n=Number(v); return isFinite(n)?n:null;};

          const assets = num(B.totalAssets) ?? num(B.totalAssetsUSD) ?? null;
          const debt   = (num(B.totalDebt) ??
                         ((num(B.shortTermDebt)||0) + (num(B.longTermDebt)||0)) ??
                         ((num(B.longTermDebtNoncurrent)||0) + (num(B.shortTermBorrowings)||0)));
          const cash   = (num(B.cashAndShortTermInvestments) ??
                         ((num(B.cashAndCashEquivalents)||0) + (num(B.shortTermInvestments)||0)));
          const revenue= num(I.revenue) ?? num(I.totalRevenue) ?? null;
          const interestIncome = Math.max(0, num(I.interestIncome) ?? num(I.interestIncomeNet) ?? num(I.investmentIncome) ?? 0);

          if(assets>0 && revenue>0){
            return { assets, debt:debt||0, cash:cash||0, revenue, interestIncome:interestIncome||0, form:"FMP-Q", end: I.date||B.date||"" };
          }
        }
        return null;
      }

      function decideStatus(dta, cta, irr){
        const debtOk = isFinite(dta) && dta <= LIMITS.MAX_DTA;
        const cashOk = isFinite(cta) && cta <= LIMITS.MAX_CTA;

        if(!debtOk || !cashOk){
          const reasons=[];
          if(!debtOk) reasons.push(`الدين/الأصول > ${(LIMITS.MAX_DTA*100).toFixed(0)}%`);
          if(!cashOk) reasons.push(`النقدية/الأصول > ${(LIMITS.MAX_CTA*100).toFixed(0)}%`);
          if(irr > LIMITS.MAX_IMPURE) reasons.push(`الدخل غير المباح ${(irr*100).toFixed(2)}%`);
          return { status:"حرام", note: reasons.join(" | ") };
        }
        if(irr===0) return { status:"حلال", note:"" };
        if(irr>0 && irr<=LIMITS.MAX_IMPURE) return { status:"حلال (يحتاج تطهير)", note:`نسبة التطهير = ${(irr*100).toFixed(2)}% من الأرباح.` };
        return { status:"حرام", note:`الدخل غير المباح ${(irr*100).toFixed(2)}%` };
      }

      function render(t, cik, data, source, reportMeta){
        const out = document.getElementById("out");
        const cls =
          data.status.startsWith("حلال") ? "ok" :
          data.status==="حرام" ? "bad" :
          "neutral"; // مباح

        out.innerHTML = `
          <div class="card">
            <div class="row-top">
              <div>
                <div style="font-size:18px;font-weight:700">${t} — CIK ${String(cik).padStart(10,"0")}
                  <span class="source">المصدر: ${source}</span>
                </div>
                <div class="source">Q — ${reportMeta.end || ""}</div>
              </div>
              <span class="badge ${cls}">${data.status}</span>
            </div>

            <div class="grid">
              <div class="tile"><div class="k">الدَّخْل غير المباح</div><div class="v">${pct(data.irr)}</div></div>
              <div class="tile"><div class="k">النقدية / الأصول</div><div class="v">${pct(data.cta)}</div></div>
              <div class="tile"><div class="k">الدين / الأصول</div><div class="v">${pct(data.dta)}</div></div>
            </div>

            ${data.note ? `<div class="muted">${data.note}</div>` : ``}
            <div class="muted">المعايير: الدين ≤ 30%، النقدية ≤ 30%، الدخل غير المباح ≤ 5%.</div>
          </div>`;
      }

      document.getElementById("btn").onclick = async () => {
        const t = document.getElementById("ticker").value.trim().toUpperCase();
        const out = document.getElementById("out");
        const err = document.getElementById("error");
        err.textContent = ""; out.innerHTML = "";
        if(!t){ err.textContent = "اكتب رمز السهم أولًا"; return; }

        try{
          let source = "SEC";
          const cik = await mapTickerToCik(t);

          // نشاط محرّم (SIC) = تحريم فوري
          const submissions = await fetchSEC(`https://data.sec.gov/submissions/CIK${pad10(cik)}.json`);
          const sicDesc = (submissions.sicDescription || "").toLowerCase();
          if (BANNED.find(k => sicDesc.includes(k))){
            render(t, cik, {dta:null, cta:null, irr:null, status:"حرام", note:`نشاط مستبعد: ${submissions.sicDescription||""}`}, source, {end:""});
            return;
          }

          // SEC: آخر ربع ثم السابق فقط
          let picked = null;
          try{
            const facts = await fetchSEC(`https://data.sec.gov/api/xbrl/companyfacts/CIK${pad10(cik)}.json`);
            const F = (facts.facts && facts.facts["us-gaap"]) ? facts.facts["us-gaap"] : {};
            const ends = lastTwoQuarterEnds(F);
            picked = tryPickQuarterSEC(F, ends);
          }catch(_){}

          // FMP لو SEC ناقص
          if(!picked){
            const f = await fetchFromFMP_Q_LastTwo(t);
            if(f){ picked = {...f}; source = "FMP (quarter)"; }
          }

          // لا SEC ولا FMP → مباح (نقص بيانات)
          if(!picked){
            render(t, cik, {dta:null, cta:null, irr:null, status:"مباح", note:"بيانات الربع غير مكتملة."}, source, {end:""});
            return;
          }

          // حساب النِّسَب
          const dta = safeDiv(picked.debt||0, picked.assets||1);
          const cta = safeDiv(picked.cash||0, picked.assets||1);
          const irr = Math.min(1, safeDiv(picked.interestIncome||0, picked.revenue||1));

          const decision = decideStatus(dta, cta, irr);
          render(t, cik, {dta, cta, irr, status:decision.status, note:decision.note}, source, {end:picked.end});
        }catch(e){
          document.getElementById("error").textContent = "خطأ: " + (e.message || e);
        }
      };
    </script>
  </body>
</html>
