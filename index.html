<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Halal Stock Checker (SEC)</title>
    <style>
      body{font-family:system-ui,Segoe UI,Tahoma,Arial,sans-serif;max-width:900px;margin:40px auto;padding:16px}
      .row{display:flex;gap:8px;margin:12px 0}
      input{flex:1;padding:10px 12px;border:1px solid #ddd;border-radius:10px;text-transform:uppercase}
      button{padding:10px 16px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;cursor:pointer}
      .card{border:1px solid #eee;border-radius:12px;padding:16px;margin-top:12px}
      .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px}
      .tile{border:1px solid #f1f1f1;border-radius:10px;padding:12px}
      .k{opacity:.7;font-size:12px}
      .v{font-size:20px;font-weight:700}
      .badge{padding:6px 10px;border-radius:16px;font-weight:700}
      .ok{background:#e6f7e9;color:#167c2b}
      .bad{background:#fde8e8;color:#b00020}
      .warn{background:#fff8e1;color:#a67c00}
      .neutral{background:#e9f2ff;color:#0a53a3}
      .muted{opacity:.65;font-size:12px;margin-top:10px}
      .err{color:#b00020;margin-top:8px}
      .source{font-size:12px;opacity:.7;margin-inline-start:8px}
      .row-top{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
      .note{font-size:12px;opacity:.75}

      /* بانر سياسة البيانات — واضح وثابت */
      .notice{
        background:#f5f7ff;
        border:1px solid #dfe7ff;
        color:#0a2a66;
        padding:12px 14px;
        border-radius:12px;
        line-height:1.8;
        margin:12px 0 16px;
        font-size:14px;
      }
      .notice b{color:#06245a}
    </style>
  </head>
  <body>
    <h1>Halal Stock Checker (SEC)</h1>

  


    <div class="row">
      <input id="ticker" placeholder="AAPL, TSLA, MSFT ..." />
      <button id="btn">فحص</button>
    </div>

    <div id="error" class="err"></div>
    <div id="out"></div>

    <script>
      /* ===== إعدادات ===== */
      const PROXY = "https://sec-proxy.vercel.app/api/sec-proxy"; // بروكسي SEC
      const FMP_KEY = "pIugzfG67qw0hwcFvzzSzF2Zax1eZXt6";        // مفتاح FMP

      const LIMITS = { MAX_DTA: 0.30, MAX_CTA: 0.30, MAX_IMPURE: 0.05 };
      const BANNED = [
        "alcohol","brewery","wine","spirits","gambling","casino","lottery",
        "pork","swine","pig","tobacco","cannabis","adult","porn",
        "bank","banking","mortgage","insurance","reinsurance","weapons","firearms","defense"
      ];

      const pct = x => (typeof x === "number" ? (x*100).toFixed(2) + "%" : "-");
      const sleep = ms => new Promise(r=>setTimeout(r,ms));

      /* ===== SEC helpers ===== */
      async function fetchSEC(url, type="json", retries=4){
        let lastErr;
        for(let i=0;i<retries;i++){
          try{
            await sleep(250 + i*600);
            const r = await fetch(PROXY + "?u=" + encodeURIComponent(url), {cache:"no-store"});
            if(!r.ok) throw new Error("SEC HTTP "+r.status);
            return (type==="text") ? await r.text() : await r.json();
          }catch(e){ lastErr = e; }
        }
        throw lastErr || new Error("SEC fetch failed");
      }

      function pad10(cik){ let s=String(Math.trunc(Number(cik)||0)); while(s.length<10) s="0"+s; return s; }
      function safeDiv(a,b){ return (isFinite(a)&&isFinite(b)&&b!==0)?(a/b):0; }
      function sumPos(arr){ return arr.reduce((s,x)=>s+(isFinite(x)&&x>0?x:0),0); }

      // كل تواريخ 10-Q (أحدث ← أقدم)
      function listQuarterEnds(F){
        const ends = new Set();
        const collect = (node)=>{
          if(!node||!node.units) return;
          const usd = node.units.USD || node.units.usd; if(!usd) return;
          usd.forEach(e=>{
            if((e.form||"").toUpperCase()==="10-Q" && e.end) ends.add(e.end);
          });
        };
        Object.values(F||{}).forEach(collect);
        return Array.from(ends).sort((a,b)=>new Date(b)-new Date(a));
      }

      // قيمة مفتاح GAAP محدد لنهاية ربع معينة
      function pickForEnd(F, keys, end){
        for(const k of keys){
          const node = F[k]; if(!node||!node.units) continue;
          const usd = node.units.USD || node.units.usd; if(!usd) continue;
          const exactQ = usd.find(e => (e.form||"").toUpperCase()==="10-Q" && e.end===end);
          if(exactQ && isFinite(Number(exactQ.val))) return Number(exactQ.val);
          const exactAny = usd.find(e => e.end===end);
          if(exactAny && isFinite(Number(exactAny.val))) return Number(exactAny.val);
        }
        return null;
      }

      async function mapTickerToCik(ticker){
        try{
          const txt = await fetchSEC("https://www.sec.gov/include/ticker.txt","text");
          const hit = txt.split(/\r?\n/).find(line => {
            const p=line.trim().split(/[|\s]+/);
            return p[0] && p[0].toUpperCase()===ticker.toUpperCase();
          });
          if(hit){
            const parts = hit.trim().split(/[|\s]+/);
            const cikStr = parts[1].replace(/^0+/,"");
            return Number(cikStr);
          }
        }catch(_){}
        try{
          const j1 = await fetchSEC("https://www.sec.gov/files/company_tickers.json");
          const a1 = Array.isArray(j1)?j1:Object.values(j1||{});
          const h1 = a1.find(o => (o.ticker||"").toUpperCase()===ticker.toUpperCase());
          if(h1) return Number(h1.cik_str || h1.cik);
        }catch(_){}
        const j2 = await fetchSEC("https://www.sec.gov/files/company_tickers_exchange.json");
        const a2 = Array.isArray(j2)?j2:Object.values(j2||{});
        const h2 = a2.find(o => (o.ticker||"").toUpperCase()===ticker.toUpperCase());
        if(h2) return Number(h2.cik_str || h2.cik);
        throw new Error("Ticker not found via SEC maps");
      }

      /* ===== FMP fallback (quarter) — لا ترمي أخطاء ===== */
      async function fetchFromFMPQuarterRolling(ticker){
        const base = "https://financialmodelingprep.com/api/v3";
        const qs = `?period=quarter&limit=4&datatype=json&apikey=${encodeURIComponent(FMP_KEY)}`;

        let bsArr = [], isArr = [];
        try {
          const [bsRes, isRes] = await Promise.allSettled([
            fetch(`${base}/balance-sheet-statement/${encodeURIComponent(ticker)}${qs}`),
            fetch(`${base}/income-statement/${encodeURIComponent(ticker)}${qs}`)
          ]);

          if (bsRes.status === "fulfilled" && bsRes.value.ok) bsArr = await bsRes.value.json();
          if (isRes.status === "fulfilled" && isRes.value.ok) isArr = await isRes.value.json();
        } catch(_) {}

        if (!Array.isArray(bsArr)) bsArr = [];
        if (!Array.isArray(isArr)) isArr = [];

        for (let i = 0; i < 4; i++) {
          const bs = bsArr[i] || {};
          const is_ = isArr[i] || {};
          const num = v => { const n = Number(v); return isFinite(n) ? n : null; };

          const assets = num(bs.totalAssets) ?? num(bs.totalAssetsUSD) ?? null;
          const debt   = (num(bs.totalDebt) ?? ((num(bs.shortTermDebt)||0) + (num(bs.longTermDebt)||0)));
          const cash   = (num(bs.cashAndShortTermInvestments) ?? ((num(bs.cashAndCashEquivalents)||0) + (num(bs.shortTermInvestments)||0)));
          const revenue= num(is_.revenue) ?? num(is_.totalRevenue) ?? null;
          const interestIncome = Math.max(0, num(is_.interestIncome) ?? num(is_.interestIncomeNet) ?? num(is_.investmentIncome) ?? 0);

          if (assets > 0 && revenue > 0) {
            return {
              assets, debt: debt || 0, cash: cash || 0, revenue,
              interestIncome: interestIncome || 0, form: "FMP-Q",
              end: is_.date || bs.date || ""
            };
          }
        }
        return null;
      }

      /* ===== العرض ===== */
      function render(t, cik, data, source, reportMeta){
        const out = document.getElementById("out");
        const badClass =
          data.status==="Halal" ? "ok" :
          data.status==="Haram" ? "bad" :
          data.status==="Needs Purification" ? "warn" :
          "neutral"; // Mubah

        const rep = reportMeta ? `${reportMeta.form || ""} — ${reportMeta.end || ""}` : "";
        const noteLine = data.note ? data.note
          : (data.status==="Mubah" ? "لا توجد بيانات ربعية مكتملة. رجعنا للقاعدة: الأصل الإباحة حتى يصدر 10-Q." : "");

        out.innerHTML = `
          <div class="card">
            <div class="row-top">
              <div>
                <div style="font-size:18px;font-weight:600">${t} — CIK ${String(cik).padStart(10,"0")}
                  <span class="source">Source: ${source}</span>
                </div>
                <div class="note">${rep}</div>
              </div>
              <span class="badge ${badClass}">${data.status}</span>
            </div>

            <div class="grid">
              <div class="tile"><div class="k">Impure Revenue</div><div class="v">${pct(data.irr)}</div></div>
              <div class="tile"><div class="k">Cash / Assets</div><div class="v">${pct(data.cta)}</div></div>
              <div class="tile"><div class="k">Debt / Assets</div><div class="v">${pct(data.dta)}</div></div>
            </div>

            <div class="muted">${noteLine}</div>
            <div class="muted">المعايير (ربعي): الدين ≤ 30%، النقدية ≤ 30%، الإيراد غير المباح ≤ 5%.</div>
          </div>`;
      }

      function decideStatus(dta, cta, irr){
        const debtOk = isFinite(dta) && dta <= LIMITS.MAX_DTA;
        const cashOk = isFinite(cta) && cta <= LIMITS.MAX_CTA;

        if(!debtOk || !cashOk){
          const reasons=[];
          if(!debtOk) reasons.push(`Debt/Assets > ${(LIMITS.MAX_DTA*100).toFixed(0)}%`);
          if(!cashOk) reasons.push(`Cash/Assets > ${(LIMITS.MAX_CTA*100).toFixed(0)}%`);
          if(irr > LIMITS.MAX_IMPURE) reasons.push(`Impure Rev ${(irr*100).toFixed(2)}% > ${(LIMITS.MAX_IMPURE*100).toFixed(0)}%`);
          return { status:"Haram", note: reasons.join(" | ") };
        }
        if(irr===0) return { status:"Halal", note:"" };
        if(irr>0 && irr<=LIMITS.MAX_IMPURE) return { status:"Needs Purification", note:`Purification = ${(irr*100).toFixed(2)}% of gains.` };
        return { status:"Haram", note:`Impure revenue ${(irr*100).toFixed(2)}% > ${(LIMITS.MAX_IMPURE*100).toFixed(0)}%.` };
      }

      /* ===== الحدث الرئيسي ===== */
      document.getElementById("btn").onclick = async () => {
        const t = document.getElementById("ticker").value.trim().toUpperCase();
        const out = document.getElementById("out");
        const err = document.getElementById("error");
        err.textContent = ""; out.innerHTML = "";
        if(!t){ err.textContent = "اكتب رمز السهم أولاً"; return; }

        try{
          let source = "SEC";
          const cik = await mapTickerToCik(t);

          // فحص النشاط (SIC)
          const submissions = await fetchSEC(`https://data.sec.gov/submissions/CIK${pad10(cik)}.json`);
          const sicDesc = (submissions.sicDescription || "").toLowerCase();
          const banned = BANNED.find(k => sicDesc.includes(k));
          if (banned){
            render(t, cik, {dta:null, cta:null, irr:null, status:"Haram",
              note:`Excluded by SIC: ${submissions.sic} ${submissions.sicDescription||""}`},
              source, {form:"SIC", end:""});
            return;
          }

          // CompanyFacts: جرّب آخر ربع ثم الذي قبله…
          let assets=null, debt=null, cash=null, revenue=null, interestIncome=0;
          let form="10-Q", end="";
          try{
            const facts = await fetchSEC(`https://data.sec.gov/api/xbrl/companyfacts/CIK${pad10(cik)}.json`);
            const F = (facts.facts && facts.facts["us-gaap"]) ? facts.facts["us-gaap"] : {};

            const ends = (()=>{
              const qEnds = (function listQuarterEndsInner(F){
                const ends = new Set();
                Object.values(F||{}).forEach(node=>{
                  if(node?.units){
                    const usd=node.units.USD||node.units.usd;
                    (usd||[]).forEach(e=>{ if((e.form||"").toUpperCase()==="10-Q" && e.end) ends.add(e.end); });
                  }
                });
                return Array.from(ends).sort((a,b)=>new Date(b)-new Date(a));
              })(F);

              if(qEnds.length) return qEnds;

              // لو ما فيه 10-Q، خذ أي تواريخ موجودة
              const s = new Set();
              Object.values(F||{}).forEach(node=>{
                if(node?.units){
                  const usd=node.units.USD||node.units.usd;
                  (usd||[]).forEach(e=>{ if(e.end) s.add(e.end); });
                }
              });
              return Array.from(s).sort((a,b)=>new Date(b)-new Date(a));
            })();

            for(const e of ends){
              const a = pickForEnd(F,["Assets"], e);
              const d = pickForEnd(F,["Debt","InterestBearingLiabilities","Liabilities"], e);
              const c1= pickForEnd(F,["CashAndCashEquivalentsAtCarryingValue"], e) || 0;
              const c2= pickForEnd(F,["ShortTermInvestments"], e) || 0;
              const r = pickForEnd(F,["Revenues","SalesRevenueNet","RevenueFromContractWithCustomerExcludingAssessedTax"], e);
              const i1= pickForEnd(F,["InterestIncome"], e) || 0;
              const i2= pickForEnd(F,["InterestAndDividendIncomeOperating"], e) || 0;
              const i3= pickForEnd(F,["InterestAndDividendIncome"], e) || 0;
              const i4= pickForEnd(F,["InterestIncomeNonoperating"], e) || 0;
              const i5= pickForEnd(F,["InvestmentIncomeInterest"], e) || 0;

              if(a>0 && r>0){
                assets=a; debt=(d||0); cash=(c1+c2); revenue=r;
                interestIncome=sumPos([i1,i2,i3,i4,i5]);
                end=e; // هذا الربع المعتمد
                break;
              }
            }
          }catch(_){}

          // لو SEC ما عطانا ربع مكتمل → FMP
          if(!(assets>0 && revenue>0)){
            const f = await fetchFromFMPQuarterRolling(t);
            if(f){
              assets=f.assets; debt=f.debt; cash=f.cash; revenue=f.revenue; interestIncome=f.interestIncome;
              form=f.form; end=f.end; source="FMP (quarter)";
            }
          }

          // إن لم تتوفر بيانات مكتملة → Mubah
          if(!(assets>0 && revenue>0)){
            render(t, cik, {dta:null, cta:null, irr:null, status:"Mubah", note:"No complete quarterly data found."}, source, {form:"", end:""});
            return;
          }

          const dta = safeDiv(debt||0, assets||1);
          const cta = safeDiv(cash||0, assets||1);
          const irr = Math.min(1, safeDiv(interestIncome||0, revenue||1));

          const decision = decideStatus(dta, cta, irr);
          render(t, cik, {dta,cta,irr,status:decision.status,note:decision.note}, source, {form, end});
        }catch(e){
          document.getElementById("error").textContent = "Error: " + (e.message || e);
        }
      };
    </script>
  </body>
</html>
